<!--------------------------
*	                       *
*  K-means visualization   *
*                          *
*  author:keisuke usami    *
--------------------------->
<!DOCTYPE html>
<html>
<head>
<title>K-means_Algorithem</title>
<meta charset="utf-8">
<script type="text/javascript" src="./d3.v3.js"></script>
</head>
<body>
<h1 style="background-color:tomato;color:#fff;font-family:Arial,sans-selif;padding-left:30px;margin:0px;height:50px;padding-top:10px">k-means visualization</h1>
<div>
	<div style="width:800px;margin:auto;overflow:hidden">
		<div style="float:left;width:400px">
			<p style="text-align:center">Data Distribution</p>			
		</div>
		<div style="float:right;width:400px">
			<p style="text-align:center">Real Data Distribution</p>
		</div>
	</div>
</div>
<div>
	<div id="box" style="width:800px;margin:auto"><!--svg erea-->
	</div>
</div>		
<script type="text/javascript">
/*Variable declaration*/

	var w = 400;			// width of one rectangle in the svg 
	var h = 400;	    	// height of one rectangle in the svg
	var padding = 10;   	// rectangle padding   
	var rect = [1];     	// the number of rect
	var C_data = [];    	// center of each gauss distribution
	var dataset = [];   	// data  
	var r_dataset = [];     // round dawn to data 
	var numDataPoints = 100;// the number of each gauss distribution
	var count = 200;	    // Max iteration number
	var index = [];         

	var svg = d3.select("#box")   //right rectangle declaration
				.append("svg")
			　　.attr("width",w)
				.attr("height",h);

	var svg1 = d3.select("#box") //left rectangle declarartion
			     .append("svg")
				 .attr("width",w)
			     .attr("height",h);

/*generate right rectangle*/
	svg.selectAll("rect")
	   .data(rect)
	   .enter()
	   .append("rect")
	   .attr("x",0)
	   .attr("y",0)
	   .attr("width",0)
	   .attr("height",0)
	   .attr("fill","white")
	   .transition()
	   .delay(500)
	   .duration(500)
	   .attr("width",w)
	   .attr("height",h)
	   .attr("stroke","rgba(100,100,100,0.5)");

/*generate left rectangle*/		 
        svg1.selectAll("rect")
			.data(rect)
			.enter()
			.append("rect")
			.attr("x",0)
			.attr("y",0)
			.attr("height",0)
			.attr("width",0)
			.attr("fill","white")
			.transition()
			.delay(500)
			.duration(500)
			.attr("width",w)
			.attr("height",h)
			.attr("stroke","rgba(100,100,100,0.5)");				
</script>

<!--form erea-->
		<div style="margin-top:50px;margin-left:250px">
			<form action="#" id="form1" style="float:reft;">
				<p>Initialization:
				<input type="text" name="Ini">
				<input type="submit" value="submit">
				</p>
			</form>
			<form action="#" id="form2" style="float:reft;">
				<p>Estimation:<span style="margin-right:8px"></span>
				<input type="text" name="num_c">
				<input type="submit" value="submit">
				</p>
			</form>
		</div>
<!--Initailzation form processing-->

	<script type="text/javascript">
		document.getElementById('form1').onsubmit = function(){
			var num_c = document.getElementById('form1').Ini.value;//constant user dicide the number of cluster
			
			for(var i=0;i<num_c;i++){
	
				var mean_x = Math.random()*60-30;//x-coordinate mean in the each cluster 
				var mean_y = Math.random()*60-30;//y-cordinate mean in the ecah cluster
				C_data.push([Math.floor(mean_x),Math.floor(mean_y)]);
				for(var t=0;t<numDataPoints;t++){
				  var r_newNumber1 = mean_x+2*Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random());//random x-cordinate number generated by gauss distribution
				  var r_newNumber2 = mean_y+2*Math.sqrt(-2*Math.log(Math.random()))*Math.sin(2*Math.PI*Math.random());//random y-cordinate number generated by gauss distribution	
				  var newNumber1 = Math.floor(r_newNumber1);
				  var newNumber2 = Math.floor(r_newNumber2);
					  dataset.push([newNumber1,newNumber2]);
					  r_dataset.push([r_newNumber1,r_newNumber2]);
				};
			};

			var xScale = d3.scale.linear()//scaling
						   .domain([d3.min(dataset,function(d){
							return d[0];
							}),
							d3.max(dataset,function(d){
							return d[0];
							})
							])
							.range([padding,w-padding]);
			
			var yScale = d3.scale.linear()//scaling
						   .domain([d3.min(dataset,function(d){
								return d[1];
							}),
							
									d3.max(dataset,function(d){
								return d[1];
					
							})
							])
							.range([h-padding,padding]);

/*generate circle in right rectangle*/
			svg.selectAll("circle")
			   .data(dataset)
			   .enter()
			   .append("circle")
		       .attr("cx",w)
			   .attr("cy",h)
			   .attr("r",0);
			   
			svg.selectAll("circle")
			   .data(dataset)
			   .transition()
			   .duration(1000)
			   .attr("cx",function(d){
					return xScale(d[0]);
				})
				.attr("cy",function(d){
					return yScale(d[1]); 
				})
				.attr("r",3)
				.attr("fill","orange");

/*generate circle in left rectangle*/				
			svg1.selectAll("circle")
                .data(dataset)
                .enter()
                .append("circle")
                .attr("cx",w)
                .attr("cy",h)
                .attr("r",0);
        
            svg1.selectAll("circle")
                .data(dataset)
                .transition()
                .duration(1000)
                .attr("cx",function(d){
                    return xScale(d[0]);
                })
                .attr("cy",function(d){
                    return  yScale(d[1]);
                })
               .attr("r",3)
               .attr("fill",function(d,i){
                     if(i%100==0){
                          col1 = Math.floor(Math.random()*255);
                          col2 = Math.floor(Math.random()*255);
                          col3 = Math.floor(Math.random()*255);
                     }
                     alpha = 0.5;                        
                         return "rgba("+col1+","+col2+","+col3+","+alpha+")";
             });
	return false;
	};
	</script>

<!--Estimation form proccesing -->
	<script type="text/javascript">
	document.getElementById('form2').onsubmit = function(){
             var true_c = document.getElementById('form2').num_c.value;
	         var est_c	= k_means(r_dataset,true_c,count);
			 var xScale = d3.scale.linear()
                             .domain([d3.min(dataset,function(d){
                                  return d[0];
                              }),
                          
                                      d3.max(dataset,function(d){
                                  return d[0];                             })
                              ])
                              .range([padding,w-padding]);
              var yScale = d3.scale.linear()
                             .domain([d3.min(dataset,function(d){
                                  return d[1];
                              }),
                              
                                      d3.max(dataset,function(d){
                                  return d[1];
                              })
                              ])
                              .range([h-padding,padding]);

			 svg.selectAll("ellipse")	
				.data(est_c)
				.enter()	
				.append("ellipse")
				.attr("cx",w)
				.attr("cy",h)	
				.attr("rx",5)
				.attr("ry",5)
				.attr("fill","white");
			
			svg.selectAll("ellipse")
			   .data(est_c)
			   .transition()
			   .duration(1000)
			   .attr("cx",function(d){
					return xScale(d[0]);
				})			 
			   .attr("cy",function(d){
					return yScale(d[1]);
				})
			   .attr("fill","tomato");
				
			svg.selectAll("line")
			   .data(dataset)
			   .enter()
			   .append("line")
			   .attr("x1",function(d){
					return xScale(d[0]);
				})
				.attr("x2",function(d){
					return	xScale(d[0]);
				})
				.attr("y1",function(d){
					return yScale(d[1]);
				})
				.attr("y2",function(d){
					return yScale(d[1]);
				})
				.attr("stroke","tomato");
			
			svg.selectAll("line")
			   .transition()
			   .duration(1000)
			   .delay(1000)
			   .attr("x2",function(d,i){
					for(var s=0;s<true_c;s++){
						if(index[i]==s){
							return xScale(est_c[s][0]);
						};
					};
				})
				.attr("y2",function(d,i){
					for(var s=0;s<true_c;s++){
						if(index[i]==s){
							return yScale(est_c[s][1]);
						};
					};
				});		
	return false;
	};
	</script>
	<script type="text/javascript">
         
//k_means processing

var k_means = function(r_dataset,true_c,count){
		
//ture_c is decided by usr
var	 ini_value1 = [];
var  New_Treshold = 0;
var  Old_Treshold = 1000000000;	
//step1

	for(var i=0;i<true_c;i++){	
		ini_value_x = Math.random()*60-30; 
		ini_value_y = Math.random()*60-30;
		ini_value1.push([ini_value_x, ini_value_y]);
	};

//step2

for(var s=0;s<count;s++){
		New_Treshold = 0;
		for(var i=0;i<r_dataset.length;i++){
			R = [];
			for(var t=0;t<true_c;t++){
				r = 0;
				for(var j=0;j<2;j++){
					r1  = (ini_value1[t][j] - r_dataset[i][j])**2;
					r = r + r1;
				};
				R.push(r);			
			};
			index.push(getMin(R));
			New_Treshold = New_Treshold + Math.min.apply(null,R);
		};

		if(New_Treshold - Old_Treshold == 0){
			console.log(s);
			break;
		}
		console.log(New_Treshold);
//step3
		clu_n = [];
		for(var t=0;t<true_c;t++){
			clu_n.push(0);
		};
		clu_s = [];
		for(var t=0;t<true_c;t++){
			clu_s.push([0,0]);
		};
	
		for(var i=0;i<dataset.length;i++ ){
			for(var t=0;t<true_c;t++){
				if(index[i] == t){
					clu_n[t] = clu_n[t] +	1;
					clu_s[t][0] = clu_s[t][0] + r_dataset[i][0];
					clu_s[t][1] = clu_s[t][1] + r_dataset[i][1]; 	
				};
			};
		};
			
		for(var i=0;i<true_c;i++){
			if(clu_n[i] != 0){
				ini_value1[i][0] = clu_s[i][0]/clu_n[i];
				ini_value1[i][1] = clu_s[i][1]/clu_n[i];
			}else{
				console.log("Hello");
				ini_value1[i][0] = Math.random()*60-30;
				ini_value1[i][1] = Math.random()*60-30;	
				};
		};
		if(s != count-1){
			index = [];
		};
		if(s == count - 1){
			console.log("dead");
		}
		Old_Treshold = New_Treshold;		
};
	for(var t=0;t<true_c;t++){
		ini_value1[t][0] = Math.floor(ini_value1[t][0]);
		ini_value1[t][1] = Math.floor(ini_value1[t][1]);	
	};
	return ini_value1;
};
	var getMin =  function(arr){
			if(arr.length==0){
			return -1;
			}
			var minId = 0;
			for(var id =1;id<arr.length;id++){
				if(arr[id] < arr[minId]){
					minId = id;
				}
			}
			return minId;
	}
	</script>
</body>
</html> 
